{{- if .Values.migration.workflowTemplate.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: storage-migration-template
  namespace: {{ .Release.Namespace }}
spec:
  entrypoint: migrate-storage
  # Use the cloudvault service account which has permissions to create PVCs
  serviceAccountName: {{ .Values.serviceAccount.name }}
  arguments:
    parameters:
      - name: pvc-name
      - name: src-namespace
      - name: target-storage-class
      - name: target-size
      - name: target-tier
  
  templates:
    - name: migrate-storage
      inputs:
        parameters:
          - name: pvc-name
          - name: src-namespace
          - name: target-storage-class
          - name: target-size
          - name: target-tier
      steps:
        - - name: create-target-pvc
            template: provision-target
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{`{{inputs.parameters.pvc-name}}`}}"
                - name: src-namespace
                  value: "{{`{{inputs.parameters.src-namespace}}`}}"
                - name: target-storage-class
                  value: "{{`{{inputs.parameters.target-storage-class}}`}}"
                - name: target-size
                  value: "{{`{{inputs.parameters.target-size}}`}}"
                - name: target-tier
                  value: "{{`{{inputs.parameters.target-tier}}`}}"
        - - name: verify-migration
            template: validate
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{`{{inputs.parameters.pvc-name}}`}}"
    
    - name: provision-target
      inputs:
        parameters:
          - name: pvc-name
          - name: src-namespace
          - name: target-storage-class
          - name: target-size
          - name: target-tier
      container:
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            PVC_NAME="{{`{{inputs.parameters.pvc-name}}`}}"
            SRC_NS="{{`{{inputs.parameters.src-namespace}}`}}"
            TARGET_SC="{{`{{inputs.parameters.target-storage-class}}`}}"
            TARGET_SIZE="{{`{{inputs.parameters.target-size}}`}}"
            TARGET_TIER="{{`{{inputs.parameters.target-tier}}`}}"
            if [ -z "${TARGET_TIER}" ]; then TARGET_TIER="standard"; fi
            NEW_PVC_NAME="${PVC_NAME}-migrated"
            
            echo "ðŸ”§ Fetching source PVC: ${PVC_NAME} in namespace ${SRC_NS}"
            # Standardizing on quantised format from CloudVault AI Engine
            FINAL_SIZE="${TARGET_SIZE}"
            
            echo "ðŸ”¨ Creating optimized PVC: ${NEW_PVC_NAME} with class: ${TARGET_SC} and optimized size: ${FINAL_SIZE} (Tier: ${TARGET_TIER})"
            
            cat <<EOF | kubectl apply -f -
            apiVersion: v1
            kind: PersistentVolumeClaim
            metadata:
              name: ${NEW_PVC_NAME}
              namespace: ${SRC_NS}
              labels:
                cloudvault.io/migrated-from: ${PVC_NAME}
                cloudvault.io/optimized: "true"
                cloudvault.io/ai-right-sized: "true"
                cloudvault.io/tier: ${TARGET_TIER}
            spec:
              accessModes: ["ReadWriteOnce"]
              storageClassName: ${TARGET_SC}
              resources:
                requests:
                  storage: ${FINAL_SIZE}
            EOF
            
            echo "âœ… Target PVC ${NEW_PVC_NAME} provisioned successfully in ${SRC_NS} with AI optimization."
    
    - name: validate
      inputs:
        parameters:
          - name: pvc-name
      container:
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            NEW_PVC_NAME="{{`{{inputs.parameters.pvc-name}}`}}-migrated"
            echo "ðŸ” Validating migration for ${NEW_PVC_NAME}..."
            kubectl get pvc ${NEW_PVC_NAME} -n default
            echo "âœ… Migration validated: AI-optimized storage is online."
{{- end }}
